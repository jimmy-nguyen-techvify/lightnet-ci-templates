name: Semgrep SAST Scan

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Project name for DefectDojo'
        required: true
        type: string
      semgrep_config:
        description: 'Semgrep configuration to use'
        required: false
        type: string
        default: 'p/owasp-top-ten'
      dojo_url:
        description: 'DefectDojo URL'
        required: false
        type: string
        default: 'https://dojo.devfocus.site/'
      product_type:
        description: 'DefectDojo product type'
        required: false
        type: string
        default: 'Web Application'
    secrets:
      DOJO_USERNAME:
        description: 'DefectDojo username'
        required: true
      DOJO_PASSWORD:
        description: 'DefectDojo password'
        required: true
      DEFECTDOJO_API_KEY:
        description: 'DefectDojo API key (optional)'
        required: false

jobs:
  semgrep-scan:
    runs-on: ubuntu-latest

    env:
      SCAN_TYPE: "Semgrep JSON Report"
      PROJECT_NAME: ${{ inputs.project_name }}
      DOJO_URL: ${{ inputs.dojo_url }}
      DOJO_USERNAME: ${{ secrets.DOJO_USERNAME }}
      DOJO_PASSWORD: ${{ secrets.DOJO_PASSWORD }}
      DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Define scan variables
        id: vars
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            ENVIRONMENT_TYPE="Production"
          elif [[ "${GITHUB_REF_NAME}" == "beta" ]]; then
            ENVIRONMENT_TYPE="Staging"
          elif [[ "${GITHUB_REF_NAME}" == "develop" ]]; then
            ENVIRONMENT_TYPE="Development"
          else
            ENVIRONMENT_TYPE="Unknown"
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            ENGAGEMENT_NAME="Weekly Semgrep Scan [${GITHUB_REF_NAME}]"
          elif [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            ENGAGEMENT_NAME="PR Semgrep Scan [${GITHUB_HEAD_REF}]"
          else
            ENGAGEMENT_NAME="Semgrep Scan [${GITHUB_REF_NAME}]"
          fi

          echo "ENVIRONMENT_TYPE=$ENVIRONMENT_TYPE" >> $GITHUB_ENV
          echo "ENGAGEMENT_NAME=$ENGAGEMENT_NAME" >> $GITHUB_ENV

      - name: Run Semgrep analysis
        run: |
          docker run --rm -v "${{ github.workspace }}":/src semgrep/semgrep:latest \
            semgrep ci --config "${{ inputs.semgrep_config }}" --json > semgrep-report.json || true

      - name: Verify Semgrep report
        run: |
          if [ ! -s semgrep-report.json ]; then
            echo "{}" > semgrep-report.json
            echo "⚠️ Empty Semgrep report created to prevent upload error."
          fi

      - name: Upload Semgrep report to DefectDojo
        uses: portswigger-cloud/defectdojo-import-scan@main
        env:
          DEFECTDOJO_DEBUG: "true"
        with:
          defectdojo-product: ${{ env.PROJECT_NAME }}
          defectdojo-product-type: ${{ inputs.product_type }}
          defectdojo-url: ${{ env.DOJO_URL }}
          defectdojo-username: ${{ env.DOJO_USERNAME }}
          defectdojo-password: ${{ env.DOJO_PASSWORD }}
          defectdojo-engagement-name: ${{ env.ENGAGEMENT_NAME }}
          defectdojo-environment-type: ${{ env.ENVIRONMENT_TYPE }}
          defectdojo-scan-type: ${{ env.SCAN_TYPE }}
          scan-results-file-name: "semgrep-report.json"

