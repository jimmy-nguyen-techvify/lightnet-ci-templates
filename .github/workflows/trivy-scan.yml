name: Trivy Container Scan

on:
  workflow_call:
    inputs:
      project_name:
        description: 'Project name for DefectDojo'
        required: true
        type: string
      dockerfile_path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      dojo_url:
        description: 'DefectDojo URL'
        required: false
        type: string
        default: 'https://dojo.devfocus.site/'
      product_type:
        description: 'DefectDojo product type'
        required: false
        type: string
        default: 'Web Application'
    secrets:
      DOJO_USERNAME:
        description: 'DefectDojo username'
        required: true
      DOJO_PASSWORD:
        description: 'DefectDojo password'
        required: true

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    env:
      SCAN_TYPE: "Trivy Scan"
      PROJECT_NAME: ${{ inputs.project_name }}
      DOJO_URL: ${{ inputs.dojo_url }}
      DOJO_USERNAME: ${{ secrets.DOJO_USERNAME }}
      DOJO_PASSWORD: ${{ secrets.DOJO_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - name: Define scan variables
        id: vars
        run: |
          # Convert project name to valid image name
          IMAGE_NAME=$(echo "${{ env.PROJECT_NAME }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            ENVIRONMENT_TYPE="Production"
          elif [[ "${GITHUB_REF_NAME}" == "beta" ]]; then
            ENVIRONMENT_TYPE="Staging"
          elif [[ "${GITHUB_REF_NAME}" == "develop" ]]; then
            ENVIRONMENT_TYPE="Development"
          else
            ENVIRONMENT_TYPE="Unknown"
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            ENGAGEMENT_NAME="Weekly Trivy Scan [${GITHUB_REF_NAME}]"
          elif [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            ENGAGEMENT_NAME="PR Trivy Scan [${GITHUB_HEAD_REF}]"
          else
            ENGAGEMENT_NAME="Trivy Scan [${GITHUB_REF_NAME}]"
          fi

          echo "ENVIRONMENT_TYPE=$ENVIRONMENT_TYPE" >> $GITHUB_ENV
          echo "ENGAGEMENT_NAME=$ENGAGEMENT_NAME" >> $GITHUB_ENV

      - name: Build Docker image
        run: docker build -f ${{ inputs.dockerfile_path }} -t $IMAGE_NAME:scan .

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: "${{ env.IMAGE_NAME }}:scan"
          format: json
          output: trivy-report.json
          ignore-unfixed: true
          vuln-type: 'os,library'

      - name: Verify report file
        run: |
          if [ ! -s trivy-report.json ]; then
            echo "{}" > trivy-report.json
            echo "⚠️ Empty report created to prevent DefectDojo upload failure."
          fi

      - name: Upload Trivy report to DefectDojo
        uses: portswigger-cloud/defectdojo-import-scan@main
        env:
          DEFECTDOJO_DEBUG: "true"
        with:
          defectdojo-product: ${{ env.PROJECT_NAME }}
          defectdojo-product-type: ${{ inputs.product_type }}
          defectdojo-url: ${{ env.DOJO_URL }}
          defectdojo-username: ${{ env.DOJO_USERNAME }}
          defectdojo-password: ${{ env.DOJO_PASSWORD }}
          defectdojo-engagement-name: ${{ env.ENGAGEMENT_NAME }}
          defectdojo-environment-type: ${{ env.ENVIRONMENT_TYPE }}
          defectdojo-scan-type: ${{ env.SCAN_TYPE }}
          scan-results-file-name: "trivy-report.json"


